
%run ./fetch_sha_data.py -t targets.txt -o ~/ucd_project/ucd_sha_data
%run ./fetch_CFHT_data.py -t etc/WIRCam/calib_fields.txt \
      -o ~/ucd_project/ucd_cfh_data
%run ./fetch_CFHT_data.py -t targets.txt -o ~/ucd_project/ucd_cfh_data

./fetch_sha_data.py -t targets/2m0415.txt -o ~/ucd_project/ucd_targets/2m0415 \
      -f manifest_2m0415.txt
./fetch_sha_data.py -t targets/J0212.txt -o ~/ucd_project/ucd_targets/J0212 \
      -f manifest_J0212.txt
./fetch_sha_data.py -t targets/J1832.txt -o ~/ucd_project/ucd_targets/J1832 \
      -f manifest_J1832.txt
./fetch_sha_data.py -t targets/wise1828.txt -o ~/ucd_project/ucd_targets/wise1828 \
      -f manifest_wise1828.txt
./fetch_sha_data.py -t targets/wise1257.txt -o ~/ucd_project/ucd_targets/wise1257 \
      -f manifest_wise1257.txt

# ----------------------------------------------------------------------- 

./fetch_gaia_nearby.py -R 0.5 277.12595833  +26.84355556 -o csv/gaia_wise1828.csv
./fetch_gaia_nearby.py -R 0.5  63.83208333   -9.58497222 -o csv/gaia_2mass0415.csv
./fetch_gaia_nearby.py -R 0.5  33.18145833   +5.52977778 -o csv/gaia_J02124355.csv
./fetch_gaia_nearby.py -R 0.5 278.03308333  -54.16202778 -o csv/gaia_J18320794.csv
./fetch_gaia_nearby.py -R 0.3 194.33754167  +71.89702778 -o csv/gaia_wise1257.csv

# ----------------------------------------------------------------------- 

# retrieve SST ephemeris data before preprocessing:
./01_get_SST_ephemeris.py -W -I /home/rsiverd/ucd_project/ucd_targets/2m0415/ \
     -o  /home/rsiverd/ucd_project/ucd_targets/2m0415/sst_eph_2m0415.csv
./01_get_SST_ephemeris.py -W -I /home/rsiverd/ucd_project/ucd_targets/wise1828/ \
     -o  /home/rsiverd/ucd_project/ucd_targets/wise1828/sst_eph_wise1828.csv
./01_get_SST_ephemeris.py -W -I /home/rsiverd/ucd_project/ucd_targets/J0212/ \
     -o  /home/rsiverd/ucd_project/ucd_targets/wise1828/sst_eph_J0212.csv
./01_get_SST_ephemeris.py -W -I /home/rsiverd/ucd_project/ucd_targets/J1832/ \
     -o  /home/rsiverd/ucd_project/ucd_targets/wise1828/sst_eph_J1832.csv
./01_get_SST_ephemeris.py -W -I /home/rsiverd/ucd_project/ucd_targets/wise1257/ \
     -o  /home/rsiverd/ucd_project/ucd_targets/wise1257/sst_eph_wise1257.csv

# ----------------------------------------------------------------------- 

# clean images:
cd ~/ucd_project/ultracool
source ~/venv/astrom/bin/activate
source ENVIRONMENT.sh
for imdir in `ls -d ~/ucd_project/ucd_targets/*/r*`; do
   echo "imdir: $imdir"
   cmde "./02_clean_all_spitzer.py -I $imdir" || break
done

# cleaning command to test short-exposure avoidance:
./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828/r46438912

# cleaning command to test short-exposure and off-target avoidance:
./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415/r57909248 \
      -t targets/2m0415.txt --ignore_off_target

# cleaning command to reprocess everything:
./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/ \
      -t targets.txt --ignore_off_target -W

./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828/r46438912 \
      -t targets.txt --ignore_off_target \
      -E /home/rsiverd/ucd_project/ucd_targets/wise1828/sst_eph_wise1828.csv

# ----------------------------------------------------------------------- 
# Reprocess each object with ephemeris included:

./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828 \
      -t targets.txt --ignore_off_target --overwrite -W \
      -E /home/rsiverd/ucd_project/ucd_targets/wise1828/sst_eph_wise1828.csv

./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415 \
      -t targets.txt --ignore_off_target --overwrite -W \
      -E /home/rsiverd/ucd_project/ucd_targets/2m0415/sst_eph_2m0415.csv

./02_clean_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/wise1257 \
      -t targets.txt --ignore_off_target --overwrite -W \
      -E /home/rsiverd/ucd_project/ucd_targets/wise1257/sst_eph_wise1257.csv


# ----------------------------------------------------------------------- 

# extraction test:
%run ./extract_and_match_gaia.py -g ultracool/csv/gaia_wise1828.csv \
   -i ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbcd.fits
%run ./extract_and_match_gaia.py -g ultracool/csv/gaia_wise1828.csv \
   -i ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbcd.fits        \
   -u ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbunc.fits
%run ./extract_and_match_gaia.py -g ultracool/csv/gaia_wise1828.csv \
   -i ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbcd.fits        \
   -u ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbunc.fits       \
   -o ucd_fcat/SPITZER_I2_61246976_0004_0000_1_fcat.fits

%run ./extract_and_match_gaia.py -g ultracool/csv/gaia_wise1828.csv \
   -i ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbcd.fits        \
   -u ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbunc.fits       \
   -r detections.reg

# ----------------------------------------------------------------------- 

# fit/analyze testing:
%run ./slice_and_dice.py -C separate/cat_2m0415.txt -g csv/gaia_2m0415.csv

%run ./slice_and_dice.py -C separate/cat_wi1828.txt -g csv/gaia_wise1828.csv

# fit/analysis comparison:
%run ./slice_and_dice.py -C collections/wise1828_clean_fcat.txt -g csv/gaia_wise1828.csv
%run ./slice_and_dice.py -C collections/wise1828_clean_pcat.txt -g csv/gaia_wise1828.csv

# ----------------------------------------------------------------------- 

# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# PIPELINE execution:

./05_extract_all_spitzer.py -I ../ucd_sha_data -O ../ucd_sha_fcat
./05_extract_all_spitzer.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828 \
                            -O /home/rsiverd/ucd_project/ucd_targets/wise1828

./07_spitzer_aor_extraction.py \
      -I /home/rsiverd/ucd_project/ucd_targets/wise1828/r44516096 \
      -O /home/rsiverd/ucd_project/ucd_targets/wise1828/r44516096

./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415/r44717824

# troubleshoot variable output:
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415/r17577216 --hcfix

# rerun all AOR extraction:
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/ --hcfix -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/ --clean -W --overwrite

./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828/ --hcfix -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/wise1828/ --clean -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415/ --hcfix -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/2m0415/ --clean -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/wise1257/ --hcfix -W --overwrite
./07_spitzer_aor_extraction.py -I /home/rsiverd/ucd_project/ucd_targets/wise1257/ --clean -W --overwrite

# ----------------------------------------------------------------------- 

# Rebuild collections of extended catalog files:
cd collections
./01_remake_collections.sh /home/rsiverd/ucd_project/ucd_targets/2m0415   --START
./01_remake_collections.sh /home/rsiverd/ucd_project/ucd_targets/wise1828 --START

## After extraction, fix WCS zero-point errors in-place:
./08_inplace_fix_WCS_offsets.py -C collections/all_files_2m0415.txt -G csv/gaia_2m0415.csv
./08_inplace_fix_WCS_offsets.py -C collections/all_files_wise1828.txt -G csv/gaia_wise1828.csv
./08_inplace_fix_WCS_offsets.py -C collections/all_files_wise1257.txt -G csv/gaia_wise1257.csv

# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 


# master list build commands:
./10_make_master_source_list.py -C collections/2m0415_SPITZER_I1_clean_pcat.txt \
      -o process/2m0415_detections.txt


# ----------------------------------------------------------------------- 

# 2m0415, ch1 variants:
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I1_clean_fcat.txt -o process/2m0415_ch1_fcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I1_clean_pcat.txt -o process/2m0415_ch1_pcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I1_clean_mcat.txt -o process/2m0415_ch1_mcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I2_clean_fcat.txt -o process/2m0415_ch2_fcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I2_clean_pcat.txt -o process/2m0415_ch2_pcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_2m0415.csv -T targets/2m0415.par \
      -D process/2m0415_detections.txt \
      -C collections/2m0415_SPITZER_I2_clean_mcat.txt -o process/2m0415_ch2_mcat.pickle

# wise1828 fcat, both channels:
%run ./11_match_and_group_sources.py -G csv/gaia_wise1828.csv -T targets/wise1828.par \
      -D process/wise1828_detections.txt \
      -C collections/wise1828_SPITZER_I1_clean_pcat.txt -o process/wise1828_ch1_pcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_wise1828.csv -T targets/wise1828.par \
      -D process/wise1828_detections.txt \
      -C collections/wise1828_SPITZER_I2_clean_pcat.txt -o process/wise1828_ch2_pcat.pickle

# wise1828, fcat/mcat, ch1:
%run ./11_match_and_group_sources.py -G csv/gaia_wise1828.csv -T targets/wise1828.par \
      -D process/wise1828_detections.txt \
      -C collections/wise1828_SPITZER_I1_clean_fcat.txt -o process/wise1828_ch1_fcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_wise1828.csv -T targets/wise1828.par \
      -D process/wise1828_detections.txt \
      -C collections/wise1828_SPITZER_I1_clean_mcat.txt -o process/wise1828_ch1_mcat.pickle


# wise1257 pcat, both channels:
%run ./11_match_and_group_sources.py -G csv/gaia_wise1257.csv -T targets/wise1257.par \
      -D process/wise1257_detections.txt \
      -C collections/wise1257_clean_pcat.txt -o process/wise1257_pcat.pickle
%run ./11_match_and_group_sources.py -G csv/gaia_wise1257.csv -T targets/wise1257.par \
      -D process/wise1257_detections.txt \
      -C collections/wise1257_clean_pcat.txt -o process/wise1257_pcat.pickle

# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 

## unweighted ...
#./06_sextract_spitzer.sh --original -I ../ucd_sha_data -O ../ucd_scat_orig --START -r
#./06_sextract_spitzer.sh --cosclean -I ../ucd_sha_data -O ../ucd_scat_ccln --START -r
#
## weighted!
#./06_sextract_spitzer.sh --original -I ../ucd_sha_data -O ../wei_scat_orig --START -r --rmswei
#./06_sextract_spitzer.sh --cosclean -I ../ucd_sha_data -O ../wei_scat_ccln --START -r --rmswei

# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 

# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ----------------------------------------------------------------------- 
# ancillary stuff:

./compare_distortion.py -i ~/ucd_project/ucd_sha_data/SPITZER_I2_61246976_0004_0000_1_cbcd.fits


# Gaia nudge testing:
./nudge_wcs_test.py -G csv/gaia_2m0415.csv \
   -C /home/rsiverd/ucd_project/ucd_targets/2m0415/r49754880/SPITZER_I1_49754880_0006_0000_2_clean.fits.fcat


