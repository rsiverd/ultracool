#!/usr/bin/env python
# vim: set fileencoding=utf-8 ts=4 sts=4 sw=4 et tw=80 :
#
# Quick-and-dirty centroid corrections for pixel phase effects.
#
# Rob Siverd
# Created:       2020-02-12
# Last modified: 2020-02-12
#--------------------------------------------------------------------------
#**************************************************************************
#--------------------------------------------------------------------------

## Logging setup:
import logging
#logging.basicConfig(level=logging.DEBUG)
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)
#logger.setLevel(logging.DEBUG)
logger.setLevel(logging.INFO)

## Current version:
__version__ = "0.1.0"

## Modules:
import os
import sys
import time
import numpy as np
#from numpy.lib.recfunctions import append_fields
_have_np_vers = float('.'.join(np.__version__.split('.')[:2]))


##--------------------------------------------------------------------------##
## IRAC ch1 centroid corrections from Mighell (2008):
#delta,xcorr,ycorr
_nudge_table = np.array([
        [-0.50, -0.0429, -0.0136],
        [-0.49, -0.0416, -0.0118],
        [-0.48, -0.0390, -0.0085],
        [-0.47, -0.0363, -0.0053],
        [-0.46, -0.0337, -0.0019],
        [-0.45, -0.0309,  0.0017],
        [-0.44, -0.0282,  0.0049],
        [-0.43, -0.0253,  0.0081],
        [-0.42, -0.0224,  0.0115],
        [-0.41, -0.0196,  0.0146],
        [-0.40, -0.0166,  0.0180],
        [-0.39, -0.0137,  0.0214],
        [-0.38, -0.0107,  0.0247],
        [-0.37, -0.0078,  0.0280],
        [-0.36, -0.0048,  0.0309],
        [-0.35, -0.0017,  0.0341],
        [-0.34,  0.0012,  0.0376],
        [-0.33,  0.0044,  0.0404],
        [-0.32,  0.0075,  0.0432],
        [-0.31,  0.0105,  0.0462],
        [-0.30,  0.0135,  0.0491],
        [-0.29,  0.0164,  0.0518],
        [-0.28,  0.0195,  0.0548],
        [-0.27,  0.0221,  0.0572],
        [-0.26,  0.0250,  0.0596],
        [-0.25,  0.0279,  0.0622],
        [-0.24,  0.0306,  0.0646],
        [-0.23,  0.0334,  0.0666],
        [-0.22,  0.0362,  0.0687],
        [-0.21,  0.0391,  0.0705],
        [-0.20,  0.0416,  0.0722],
        [-0.19,  0.0438,  0.0739],
        [-0.18,  0.0463,  0.0752],
        [-0.17,  0.0490,  0.0766],
        [-0.16,  0.0510,  0.0775],
        [-0.15,  0.0531,  0.0782],
        [-0.14,  0.0554,  0.0786],
        [-0.13,  0.0573,  0.0787],
        [-0.12,  0.0591,  0.0785],
        [-0.11,  0.0607,  0.0782],
        [-0.10,  0.0624,  0.0772],
        [-0.09,  0.0639,  0.0759],
        [-0.08,  0.0652,  0.0742],
        [-0.07,  0.0665,  0.0720],
        [-0.06,  0.0672,  0.0693],
        [-0.05,  0.0677,  0.0659],
        [-0.04,  0.0682,  0.0620],
        [-0.03,  0.0684,  0.0574],
        [-0.02,  0.0683,  0.0520],
        [-0.01,  0.0681,  0.0458],
        [ 0.00,  0.0674,  0.0388],
        [ 0.01,  0.0662,  0.0313],
        [ 0.02,  0.0648,  0.0230],
        [ 0.03,  0.0633,  0.0143],
        [ 0.04,  0.0608,  0.0053],
        [ 0.05,  0.0581, -0.0045],
        [ 0.06,  0.0552, -0.0136],
        [ 0.07,  0.0515, -0.0223],
        [ 0.08,  0.0474, -0.0305],
        [ 0.09,  0.0428, -0.0381],
        [ 0.10,  0.0374, -0.0445],
        [ 0.11,  0.0322, -0.0504],
        [ 0.12,  0.0258, -0.0558],
        [ 0.13,  0.0197, -0.0604],
        [ 0.14,  0.0126, -0.0643],
        [ 0.15,  0.0058, -0.0676],
        [ 0.16, -0.0015, -0.0704],
        [ 0.17, -0.0088, -0.0726],
        [ 0.18, -0.0155, -0.0743],
        [ 0.19, -0.0217, -0.0755],
        [ 0.20, -0.0281, -0.0763],
        [ 0.21, -0.0344, -0.0770],
        [ 0.22, -0.0399, -0.0773],
        [ 0.23, -0.0448, -0.0771],
        [ 0.24, -0.0488, -0.0767],
        [ 0.25, -0.0528, -0.0759],
        [ 0.26, -0.0564, -0.0752],
        [ 0.27, -0.0593, -0.0745],
        [ 0.28, -0.0616, -0.0731],
        [ 0.29, -0.0635, -0.0715],
        [ 0.30, -0.0649, -0.0700],
        [ 0.31, -0.0662, -0.0681],
        [ 0.32, -0.0669, -0.0659],
        [ 0.33, -0.0673, -0.0640],
        [ 0.34, -0.0674, -0.0619],
        [ 0.35, -0.0675, -0.0595],
        [ 0.36, -0.0671, -0.0569],
        [ 0.37, -0.0665, -0.0542],
        [ 0.38, -0.0658, -0.0519],
        [ 0.39, -0.0648, -0.0491],
        [ 0.40, -0.0636, -0.0462],
        [ 0.41, -0.0620, -0.0433],
        [ 0.42, -0.0607, -0.0403],
        [ 0.43, -0.0590, -0.0372],
        [ 0.44, -0.0571, -0.0344],
        [ 0.45, -0.0553, -0.0312],
        [ 0.46, -0.0532, -0.0283],
        [ 0.47, -0.0510, -0.0250],
        [ 0.48, -0.0487, -0.0219],
        [ 0.49, -0.0465, -0.0185],
        ])


class IRACFix(object):

    def __init__(self):
        self.pfrac, self.xcorr, self.ycorr = _nudge_table.T
        return

    def get_xy_bias(self, x_obs, y_obs):
        """
        Report the measurement errors in X,Y given apparent
        (sub)pixel source position. Sense of value is X_obs - X_true.
        """
        x_nudge = np.interp(x_obs % 1.0, self.pfrac, self.xcorr)
        y_nudge = np.interp(y_obs % 1.0, self.pfrac, self.ycorr)
        return (x_nudge, y_nudge)

    def fix_centroid(self, x_obs, y_obs):
        """
        De-bias input centroids based on sub-pixel position.
        """
        x_nudge = np.interp(x_obs % 1.0, self.pfrac, self.xcorr)
        y_nudge = np.interp(y_obs % 1.0, self.pfrac, self.ycorr)
        return (x_obs - x_nudge, y_obs - y_nudge)

##--------------------------------------------------------------------------##


######################################################################
# CHANGELOG (spitz_pixphase.py):
#---------------------------------------------------------------------
#
#  2020-02-12:
#     -- Increased __version__ to 0.1.0.
#     -- First created spitz_pixphase.py.
#
